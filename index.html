<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AIç®—å‘½å¤§å¸ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.2.37/lunar.js"></script>
    <style>
        :root {
            --bg-paper: #f4f1ea;
            --ink: #2c2c2c;
            --cinnabar: #b92b27;
            --indigo: #283747;
            --gold: #d4ac0d;
            --font-serif: "Kaiti", "STKaiti", "Georgia", serif;
            --font-sans: "PingFang SC", "Microsoft YaHei", sans-serif;
            --sidebar-width: 340px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-serif);
            background-color: #202020;
            color: var(--ink);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- ç§»åŠ¨ç«¯èœå•æŒ‰é’® --- */
        .menu-toggle {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 100;
            background: var(--gold);
            color: #000;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            cursor: pointer;
        }

        /* --- å·¦ä¾§æ§åˆ¶æ  --- */
        .sidebar {
            width: var(--sidebar-width);
            min-width: var(--sidebar-width);
            background-color: #2c2c2c;
            color: #ccc;
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #000;
            box-shadow: 4px 0 15px rgba(0,0,0,0.3);
            z-index: 90;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }

        .title-box {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #444;
            margin-top: 10px; /* ç•™å‡ºç©ºé—´ç»™ç§»åŠ¨ç«¯å…³é—­æŒ‰é’® */
        }
        .title-main { font-size: 24px; color: var(--gold); font-weight: bold; letter-spacing: 2px; }
        .title-sub { font-size: 12px; color: #888; margin-top: 5px; font-family: var(--font-sans); }

        .system-switch { display: flex; background: #1a1a1a; border-radius: 4px; padding: 4px; margin-bottom: 20px; }
        .sys-btn { flex: 1; text-align: center; padding: 10px; cursor: pointer; font-size: 14px; color: #666; transition: 0.3s; border-radius: 2px; }
        .sys-btn.active { background: var(--gold); color: #1a1a1a; font-weight: bold; }

        .group-label { color: var(--gold); font-size: 12px; margin-top: 20px; margin-bottom: 8px; border-left: 3px solid var(--gold); padding-left: 8px;}
        
        select, input {
            width: 100%; padding: 10px; background: #3a3a3a; border: 1px solid #555; color: #fff;
            border-radius: 4px; font-family: var(--font-sans); font-size: 14px; margin-bottom: 10px;
        }
        select:focus, input:focus { border-color: var(--gold); outline: none; background: #444; }

        .scale-btn {
            background: #333; border: 1px solid #444; color: #aaa; padding: 8px; text-align: center;
            cursor: pointer; font-size: 13px; border-radius: 3px; transition: 0.2s;
            margin-bottom: 5px; display: inline-block; width: 48%;
        }
        .scale-btn.active { background: var(--indigo); border-color: #555; color: #fff; font-weight: bold; }

        button.run-btn {
            width: 100%; padding: 14px; background: var(--cinnabar); color: #fff; border: none;
            font-size: 16px; cursor: pointer; border-radius: 4px; font-weight: bold;
            margin-top: 25px; letter-spacing: 3px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: 0.2s; margin-bottom: 50px;
        }
        button.run-btn:active { transform: scale(0.98); }

        /* --- å³ä¾§è§†å£ --- */
        .viewport {
            flex: 1;
            background-color: var(--bg-paper);
            padding: 0;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
            display: block;
            width: 100%; /* ç¡®ä¿åœ¨ç§»åŠ¨ç«¯å æ»¡ */
        }

        .content-wrapper {
            padding: 40px;
            max-width: 1000px;
            margin: 0 auto;
            min-height: 100%;
        }

        .result-card {
            background: #fff; box-shadow: 0 5px 25px rgba(0,0,0,0.08);
            padding: 0 0 40px 0; position: relative; border-top: 6px solid var(--ink); animation: fadeIn 0.6s;
            margin-bottom: 50px; border-radius: 4px; overflow: hidden; width: 100%;
        }

        .card-header {
            padding: 25px 40px; border-bottom: 1px solid #eee; background: #fff;
            display: flex; justify-content: space-between; align-items: flex-end; flex-wrap: wrap;
        }
        .h-title { font-size: 30px; font-weight: bold; color: var(--ink); margin-right: 10px;}
        .h-meta { font-size: 14px; color: #888; font-family: var(--font-sans); margin-top: 5px; }

        .card-body { padding: 30px 40px; }

        /* é€šä¿—è§£é‡Šæ¨¡å— */
        .vernacular-box {
            background: #fffcf0; border: 1px solid #e0dacc; padding: 25px; margin-top: 25px;
            border-radius: 6px; position: relative;
        }
        .vb-title { font-weight: bold; font-size: 18px; color: #8a6d3b; margin-bottom: 15px; display: flex; align-items: center; }
        .vb-title::before { content: "ğŸ’¬"; margin-right: 10px; }
        
        .dimension-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
        .dimension-card { background: #fff; border: 1px solid #eaddcf; padding: 15px; border-radius: 4px; }
        .dc-title { font-weight: bold; color: var(--cinnabar); margin-bottom: 8px; font-size: 15px; border-bottom: 1px dashed #ccc; padding-bottom: 5px;}
        .dc-content { font-size: 14px; line-height: 1.6; color: #444; text-align: justify; }

        .logic-chain {
            font-family: var(--font-sans); font-size: 14px; color: #555; background: #f4f4f4;
            padding: 15px; border-radius: 4px; margin-bottom: 20px; line-height: 1.8; overflow-wrap: break-word;
        }
        .logic-arrow { color: #999; margin: 0 5px; display: inline-block;}
        .logic-highlight { font-weight: bold; color: var(--indigo); }

        .book-ref { text-align: right; font-size: 12px; color: #999; margin-top: 15px; font-style: italic; }

        /* èŠå¤©åŒº */
        .chat-container {
            margin-top: 40px; border-top: 2px dashed #bda27e; padding-top: 30px; background: #fdfdfd;
        }
        .chat-header { font-size: 18px; font-weight: bold; color: var(--indigo); margin-bottom: 15px; border-left: 4px solid var(--gold); padding-left: 10px;}
        
        .chat-history {
            min-height: 120px; max-height: 400px; overflow-y: auto; background: #f9f9f9; 
            border: 1px solid #eee; border-radius: 8px; padding: 20px; margin-bottom: 15px;
        }
        .chat-msg { margin-bottom: 15px; display: flex; }
        .chat-msg.user { justify-content: flex-end; }
        .chat-msg.bot { justify-content: flex-start; }
        
        .bubble { 
            padding: 10px 18px; max-width: 85%; font-size: 15px; line-height: 1.6; font-family: var(--font-sans);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); word-wrap: break-word;
        }
        .chat-msg.user .bubble { background: var(--indigo); color: #fff; border-radius: 18px 18px 2px 18px; }
        .chat-msg.bot .bubble { background: #fff; color: #333; border: 1px solid #ddd; border-radius: 18px 18px 18px 2px; }
        
        .chat-input-area { display: flex; gap: 10px; position: relative; }
        .chat-input { 
            flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 25px; 
            background: #fff; color: #333; font-size: 15px; transition: 0.3s; margin-bottom: 0;
            font-family: var(--font-sans);
        }
        .chat-btn { 
            background: var(--gold); color: #fff; border: none; padding: 0 20px; border-radius: 25px; 
            cursor: pointer; font-weight: bold; font-size: 14px; white-space: nowrap;
        }

        /* å¥‡é—¨ä¹å®« (å“åº”å¼) */
        .qimen-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px;
            background: #000; border: 2px solid #000; width: 100%; max-width: 400px; margin: 0 auto;
        }
        .q-cell {
            background: #fff; aspect-ratio: 1; position: relative; padding: 2px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .q-cell.highlight { background: #fff9c4; box-shadow: inset 0 0 0 2px var(--gold); }
        .q-god { position: absolute; top: 2px; right: 2px; font-size: 10px; color: var(--cinnabar); transform: scale(0.9); transform-origin: top right; }
        .q-star { font-weight: bold; font-size: 14px; margin-top: 8px; color: #333; }
        .q-door { color: #2e86c1; font-weight: bold; font-size: 15px; margin: 2px 0; }
        .q-gan { font-family: monospace; font-size: 12px; color: #555; }
        .q-pos { position: absolute; bottom: 1px; left: 2px; font-size: 9px; color: #ccc; transform: scale(0.9); transform-origin: bottom left; }

        /* æ¢…èŠ±å¦è±¡ */
        .gua-visual { display: flex; justify-content: center; gap: 30px; margin-bottom: 30px; flex-wrap: wrap; }
        .gua-item { text-align: center; }
        .gua-icon { font-size: 60px; line-height: 1; color: #333; transition: 0.3s; font-family: "Segoe UI Symbol", sans-serif;} 
        .gua-text { font-size: 16px; margin-top: 10px; color: #555; font-weight: bold; }
        .gua-arrow { font-size: 30px; color: #ccc; margin-top: 15px; transform: rotate(90deg); display: none;} /* æ‰‹æœºç«¯é»˜è®¤éšè—ç®­å¤´æˆ–æ”¹æ–¹å‘ */

        /* --- å“åº”å¼åª’ä½“æŸ¥è¯¢ (Mobile Responsive) --- */
        @media (max-width: 768px) {
            body { flex-direction: column; height: 100vh; overflow: hidden; }
            
            /* ä¾§è¾¹æ å˜ä¸ºæŠ½å±‰å¼ */
            .sidebar {
                position: fixed;
                top: 0; left: 0; bottom: 0;
                width: 280px; min-width: 0;
                transform: translateX(-100%);
                z-index: 1000;
                padding-top: 60px; /* é¿å¼€æ±‰å ¡èœå• */
                transition: transform 0.3s ease;
                box-shadow: 2px 0 10px rgba(0,0,0,0.5);
            }
            .sidebar.open { transform: translateX(0); }
            
            .menu-toggle { display: block; }
            
            /* é®ç½©å±‚ */
            .overlay {
                display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); z-index: 900;
            }
            .overlay.active { display: block; }

            /* å³ä¾§å†…å®¹é€‚é… */
            .viewport { padding: 0; width: 100%; height: 100%; }
            .content-wrapper { padding: 15px; padding-top: 60px; } /* é¡¶éƒ¨ç•™å‡ºèœå•ç©ºé—´ */
            
            .result-card { padding: 0 0 20px 0; border-radius: 8px; margin-bottom: 30px; }
            .card-header { padding: 20px; flex-direction: column; align-items: flex-start; }
            .card-body { padding: 20px; }
            
            .h-title { font-size: 22px; }
            .h-meta { margin-top: 5px; }

            /* è°ƒæ•´ç½‘æ ¼ */
            .dimension-grid { grid-template-columns: 1fr; }
            
            /* è°ƒæ•´å¦è±¡æ˜¾ç¤º */
            .gua-visual { gap: 15px; }
            .gua-icon { font-size: 50px; }
            .gua-arrow { display: block; transform: rotate(90deg); margin: 0; line-height: 50px; font-size: 20px; } /* ç«–æ’ç®­å¤´ */
            
            /* è°ƒæ•´å¥‡é—¨ç›˜ */
            .qimen-grid { width: 100%; max-width: 320px; }
            .q-star, .q-door { font-size: 13px; }
            
            /* èŠå¤©åŒº */
            .chat-input-area { flex-direction: row; }
            .chat-btn { padding: 0 15px; font-size: 13px; }
        }

        .hidden { display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }
    </style>
</head>
<body>

<!-- ç§»åŠ¨ç«¯é®ç½©ä¸èœå• -->
<button class="menu-toggle" onclick="toggleSidebar()">â˜° è®¾ç½®</button>
<div class="overlay" onclick="toggleSidebar()" id="overlay"></div>

<div class="sidebar" id="sidebar">
    <div class="title-box">
        <div class="title-main">ä¸‡äº‹ä¸å†³ç®—ä¸€å¦</div>
        <div class="title-sub">æ¢…èŠ±æ˜“æ•°ã€å¥‡é—¨éç”²ã€å…­çˆ»ç®—å¦</div>
    </div>
    
<div style="text-align:center; margin-bottom: 15px;">
        <a href="about.html"
           style="display:inline-block; padding:8px 18px; background:#d4ac0d; color:#000;
                  text-decoration:none; border-radius:6px; font-family:'PingFang SC','Microsoft YaHei',sans-serif;
                  font-size:14px;">
           å…­çˆ»ç®—å¦
        </a>
    </div>
    
    <div class="system-switch">
        <div class="sys-btn active" id="btn-meihua" onclick="setSystem('meihua')">æ¢…èŠ±æ˜“æ•°</div>
        <div class="sys-btn" id="btn-qimen" onclick="setSystem('qimen')">å¥‡é—¨éç”²</div>
    </div>

    <!-- æ¢…èŠ±æ˜“æ•°æ§åˆ¶ -->
    <div id="ctrl-meihua">
        <div class="group-label">èµ·å¦æ–¹å¼</div>
        <select id="mh-method" onchange="toggleMhInput()">
            <option value="time">æ—¶é—´å…ˆå¤©èµ·å¦</option>
            <option value="word">æ±‰å­—èµ·å¦ (æµ‹å­—)</option>
            <option value="number">æ•°å­—èµ·å¦ (ç‰©æ•°)</option>
            <option value="direction">æ–¹ä½èµ·å¦ (åå¤©)</option>
        </select>
        
        <div id="mh-input-box" class="hidden">
            <div class="group-label">å æµ‹å†…å®¹</div>
            <input type="text" id="mh-content" placeholder="è¾“å…¥æ±‰å­—æˆ–æ•°å­—...">
            <div id="mh-dir-select" class="hidden">
                <select id="mh-direction">
                    <option value="1">è¥¿åŒ— (ä¹¾)</option>
                    <option value="6">æ­£åŒ— (å)</option>
                    <option value="7">ä¸œåŒ— (è‰®)</option>
                    <option value="4">æ­£ä¸œ (éœ‡)</option>
                    <option value="5">ä¸œå— (å·½)</option>
                    <option value="3">æ­£å— (ç¦»)</option>
                    <option value="8">è¥¿å— (å¤)</option>
                    <option value="2">æ­£è¥¿ (å…‘)</option>
                </select>
            </div>
        </div>
    </div>

    <!-- å¥‡é—¨éç”²æ§åˆ¶ -->
    <div id="ctrl-qimen" class="hidden">
        <div class="group-label">æ—¶é—´ç»´åº¦</div>
        <div>
            <div class="scale-btn" id="scale-year" onclick="setQmScale('year')">å¹´å®¶ (å›½è¿)</div>
            <div class="scale-btn" id="scale-month" onclick="setQmScale('month')">æœˆå®¶ (è°‹æœ›)</div>
            <div class="scale-btn" id="scale-day" onclick="setQmScale('day')">æ—¥å®¶ (å‡ºè¡Œ)</div>
            <div class="scale-btn active" id="scale-hour" onclick="setQmScale('hour')">æ—¶å®¶ (å†³æ–­)</div>
        </div>

        <div id="qm-focus-box">
            <div class="group-label">é—®æµ‹ä¸»é¢˜ (AIå†³ç­–)</div>
            <select id="qm-focus">
                <option value="general">æ—¶è¿/æ€»è§ˆ</option>
                <option value="wealth">æ±‚è´¢/ç”Ÿæ„</option>
                <option value="marriage">å©šå§»/æ„Ÿæƒ…</option>
                <option value="career">å·¥ä½œ/å‡è¿</option>
                <option value="lost">å¯»ç‰©/æ•ç›—</option>
            </select>
        </div>
    </div>

    <!-- å…¬å…±æ—¶é—´ -->
    <div class="group-label">
        å…¬å†æ—¶é—´ 
        <span style="font-size:10px;color:#888;font-weight:normal">(è‡ªåŠ¨æ’ç›˜)</span>
    </div>
    <div style="display:flex; gap:5px;">
        <input type="number" id="year" placeholder="å¹´">
        <select id="month"></select>
        <select id="day"></select>
    </div>
    <div style="display:flex; gap:5px;">
        <select id="hour"></select>
        <input type="number" id="minute" value="0" placeholder="åˆ†">
    </div>
    <div id="lunar-info" style="font-size:11px; color:#888; text-align:center; margin-top:5px;"></div>

    <button class="run-btn" onclick="runAndClose()">å¼€å§‹æ¨æ¼”</button>
</div>

<div class="viewport">
    <div class="content-wrapper" id="display">
        <div style="text-align: center; margin-top: 100px; color: #888;">
            <h2>è¯·åœ¨å·¦ä¾§è®¾å®šæ¡ä»¶</h2>
            <p>æ‰‹æœºç«¯è¯·ç‚¹å‡»å·¦ä¸Šè§’â€œè®¾ç½®â€æŒ‰é’®</p>
            <p style="font-size:12px; margin-top:20px;">* ç³»ç»Ÿå·²é€‚é…æ‰‹æœºã€å¹³æ¿åŠæ¡Œé¢ç«¯</p>
        </div>
    </div>
</div>

<script>
    // ================= æ•°æ®å±‚ (Strict Classics) =================
    const ZHI_NUM = { "å­":1, "ä¸‘":2, "å¯…":3, "å¯":4, "è¾°":5, "å·³":6, "åˆ":7, "æœª":8, "ç”³":9, "é…‰":10, "æˆŒ":11, "äº¥":12 };
    
    const BAGUA = {
        1: {n:"ä¹¾", w:"é‡‘", desc:"å¤©ã€çˆ¶ã€åˆšå¥ã€åœ†æ»¡", icon:"â˜°"},
        2: {n:"å…‘", w:"é‡‘", desc:"æ³½ã€å°‘å¥³ã€å–œæ‚¦ã€å£èˆŒ", icon:"â˜±"},
        3: {n:"ç¦»", w:"ç«", desc:"ç«ã€ä¸­å¥³ã€å…‰æ˜ã€æ–‡ä¹¦", icon:"â˜²"},
        4: {n:"éœ‡", w:"æœ¨", desc:"é›·ã€é•¿ç”·ã€éœ‡åŠ¨ã€è™šæƒŠ", icon:"â˜³"},
        5: {n:"å·½", w:"æœ¨", desc:"é£ã€é•¿å¥³ã€è¿›å…¥ã€åˆ©å¸‚", icon:"â˜´"},
        6: {n:"å", w:"æ°´", desc:"æ°´ã€ä¸­ç”·ã€é™©é™·ã€æ™ºæ…§", icon:"â˜µ"},
        7: {n:"è‰®", w:"åœŸ", desc:"å±±ã€å°‘ç”·ã€åœæ­¢ã€ç¨³é‡", icon:"â˜¶"},
        8: {n:"å¤", w:"åœŸ", desc:"åœ°ã€è€æ¯ã€æŸ”é¡ºã€åŒ…å®¹", icon:"â˜·"}
    };

    const RI_JIA_MAP = {
        "å­":2,"åˆ":2, "ä¸‘":6,"æœª":6, "å¯…":1,"ç”³":1,
        "å¯":8,"é…‰":8, "è¾°":4,"æˆŒ":4, "å·³":9,"äº¥":9
    };

    let currentResult = null; 

    // ================= åˆå§‹åŒ– =================
    let system = 'meihua';
    let qmScale = 'hour';

    window.onload = function() {
        const now = new Date();
        document.getElementById('year').value = now.getFullYear();
        initSelect('month', 1, 12, now.getMonth()+1);
        initSelect('day', 1, 31, now.getDate());
        initSelect('hour', 0, 23, now.getHours());
        updateLunar();
        
        // ç§»åŠ¨ç«¯è‡ªé€‚åº”è°ƒæ•´
        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                document.getElementById('sidebar').classList.remove('open');
                document.getElementById('overlay').classList.remove('active');
            }
        });
    };

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('overlay').classList.toggle('active');
    }

    function runAndClose() {
        run();
        // å¦‚æœåœ¨ç§»åŠ¨ç«¯ï¼Œè®¡ç®—åè‡ªåŠ¨å…³é—­ä¾§è¾¹æ 
        if (window.innerWidth <= 768) {
            toggleSidebar();
        }
    }

    function initSelect(id, s, e, def) {
        const el = document.getElementById(id);
        el.innerHTML = '';
        for(let i=s; i<=e; i++) el.add(new Option(i<10?'0'+i:i, i));
        el.value = def;
    }

    function setSystem(sys) {
        system = sys;
        document.getElementById('btn-meihua').className = sys==='meihua' ? 'sys-btn active' : 'sys-btn';
        document.getElementById('btn-qimen').className = sys==='qimen' ? 'sys-btn active' : 'sys-btn';
        document.getElementById('ctrl-meihua').className = sys==='meihua' ? '' : 'hidden';
        document.getElementById('ctrl-qimen').className = sys==='qimen' ? '' : 'hidden';
    }

    function setQmScale(scale) {
        qmScale = scale;
        document.querySelectorAll('.scale-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('scale-'+scale).classList.add('active');
        document.getElementById('qm-focus-box').style.display = scale==='hour'?'block':'none';
    }

    function toggleMhInput() {
        const m = document.getElementById('mh-method').value;
        const box = document.getElementById('mh-input-box');
        const text = document.getElementById('mh-content');
        const dir = document.getElementById('mh-dir-select');
        
        if (m === 'time') {
            box.className = 'hidden';
        } else {
            box.className = '';
            if (m === 'direction') {
                text.className = 'hidden';
                dir.className = '';
            } else {
                text.className = '';
                text.placeholder = m==='word' ? 'è¯·è¾“å…¥æ±‰å­— (å¦‚ï¼šä¿¡)' : 'è¯·è¾“å…¥æ•°å­— (å¦‚ï¼š3 8)';
                dir.className = 'hidden';
            }
        }
    }

    function updateLunar() {
        const y = parseInt(document.getElementById('year').value);
        const m = parseInt(document.getElementById('month').value);
        const d = parseInt(document.getElementById('day').value);
        const h = parseInt(document.getElementById('hour').value);
        if(!y) return;
        const solar = Solar.fromYmdHms(y,m,d,h,0,0);
        const lunar = solar.getLunar();
        document.getElementById('lunar-info').innerText = 
            `å†œå†ï¼š${lunar.getYearInGanZhi()}å¹´ ${lunar.getMonthInChinese()}æœˆ${lunar.getDayInChinese()} ${lunar.getTimeZhi()}æ—¶`;
    }

    // ================= é€»è¾‘åˆ†å‘ =================
    function run() {
        const y = parseInt(document.getElementById('year').value);
        const m = parseInt(document.getElementById('month').value);
        const d = parseInt(document.getElementById('day').value);
        const h = parseInt(document.getElementById('hour').value);
        const solar = Solar.fromYmdHms(y,m,d,h,0,0);
        const lunar = solar.getLunar();

        let html = "";
        if (system === 'meihua') {
            currentResult = calculateMeiHua(lunar);
            html = renderMeiHuaUI(currentResult, lunar);
        } else {
            const focus = document.getElementById('qm-focus').value;
            currentResult = calculateQiMen(lunar, qmScale, focus);
            html = renderQiMenReport(currentResult, lunar, qmScale);
        }
        document.getElementById('display').innerHTML = html;
    }

    // ================= æ¢…èŠ±æ˜“æ•°è®¡ç®— =================
    function calculateMeiHua(lunar) {
        const method = document.getElementById('mh-method').value;
        const yZhi = lunar.getYearZhi();
        const hZhi = lunar.getTimeZhi();
        const yNum = ZHI_NUM[yZhi];
        const hNum = ZHI_NUM[hZhi];
        
        let upper, lower, yao, logStep = [];

        // å¤æ³•å–æ¨¡
        const mod8 = (n) => n % 8 === 0 ? 8 : n % 8;
        const mod6 = (n) => n % 6 === 0 ? 6 : n % 6;

        if(method === 'time') {
            const m = lunar.getMonth();
            const d = lunar.getDay();
            const sumUp = yNum + m + d;
            const sumLow = sumUp + hNum;
            upper = mod8(sumUp);
            lower = mod8(sumLow);
            yao = mod6(sumLow);
            logStep.push(`<b>æ—¶é—´èµ·å¦ï¼š</b>(å¹´${yNum}+æœˆ${m}+æ—¥${d})Ã·8 ä½™${upper}ä¸ºä¸Šå¦ï¼›åŠ æ—¶${hNum}Ã·8 ä½™${lower}ä¸ºä¸‹å¦ã€‚`);
        } 
        else if (method === 'word') {
            const txt = document.getElementById('mh-content').value.trim();
            if (!txt) return null;
            let uVal, lVal;
            if (txt.length === 1) {
                uVal = txt.charCodeAt(0) % 8 || 8; 
                lVal = hNum;
                logStep.push(`<b>æµ‹å­—èµ·å¦ï¼š</b>å•å­—"${txt}"ï¼Œå·¦é˜³å³é˜´ã€‚ä¸Šå¦${upper}ï¼Œä¸‹å¦${lower}ã€‚`);
            } else {
                const mid = Math.floor(txt.length / 2);
                uVal = mid; lVal = txt.length - mid;
                logStep.push(`<b>æµ‹å­—èµ·å¦ï¼š</b>"${txt}"å…±${txt.length}å­—ã€‚ä¸Š${uVal}å­—ï¼Œä¸‹${lVal}å­—ã€‚`);
            }
            upper = mod8(uVal);
            lower = mod8(lVal + hNum);
            yao = mod6(uVal + lVal + hNum);
        } 
        else if (method === 'number') {
            const txt = document.getElementById('mh-content').value.trim();
            const nums = txt.split(/[\s,]+/).map(n => parseInt(n)).filter(n => !isNaN(n));
            
            if (nums.length < 1) return null;
            let n1 = nums[0], n2 = nums.length > 1 ? nums[1] : hNum;
            
            upper = mod8(n1);
            lower = mod8(n2);
            yao = mod6(n1 + n2 + hNum);
            logStep.push(`<b>æ•°å­—èµ·å¦ï¼š</b>æ•°A(${n1})ä¸ºä¸Šï¼Œæ•°B(${n2})ä¸ºä¸‹ã€‚æ€»æ•°åŠ æ—¶(${hNum})æ±‚åŠ¨çˆ»ã€‚`);
        }
        else if (method === 'direction') {
            const dir = parseInt(document.getElementById('mh-direction').value);
            // ä¿®æ­£ï¼šåå¤©ç«¯æ³•ï¼Œæ–¹ä½ä¸ºä¸Šï¼Œæ—¶ä¸ºä¸‹
            upper = dir;
            lower = mod8(hNum); // æ—¶è¾°ä¸ºä¸‹å¦
            yao = mod6(dir + hNum);
            logStep.push(`<b>æ–¹ä½èµ·å¦ï¼š</b>æ–¹ä½æ•°${dir}ä¸ºä¸Šå¦ï¼Œæ—¶è¾°æ•°${hNum}ä¸ºä¸‹å¦ã€‚å’Œé™¤6å–åŠ¨çˆ»ã€‚`);
        }

        const upGua = BAGUA[upper];
        const downGua = BAGUA[lower];
        
        const isUpMove = yao > 3; 
        const ti = isUpMove ? BAGUA[lower] : BAGUA[upper]; // é™ä¸ºä½“
        const yong = isUpMove ? BAGUA[upper] : BAGUA[lower]; // åŠ¨ä¸ºç”¨
        const explain = getWuXingExplain(ti, yong);

        return { up:upGua, low:downGua, yao, ti, yong, explain, logs:logStep, type:'meihua' };
    }

    function getWuXingExplain(ti, yong) {
        const relations = {
            "é‡‘é‡‘": { r:"æ¯”å’Œ", t:"ä¸¤è€…åŒæ°”è¿æï¼Œå¦‚æœ‹å‹å¸®å¿™ï¼Œäº‹æƒ…é¡ºé‚ã€‚", money:"åˆä½œç”Ÿè´¢ï¼Œåˆ©æ¯å¹³ç¨³", career:"åŒäº‹äº’åŠ©ï¼Œé¡ºæ°´æ¨èˆŸ", love:"å¿—åŒé“åˆï¼Œç›¸å¤„èæ´½", g:"å‰" },
            "æœ¨æœ¨": { r:"æ¯”å’Œ", t:"åŒæœ¨æˆæ—ï¼ŒåŠ›é‡å¢å¼ºï¼Œåˆä½œæ„‰å¿«ã€‚", money:"åˆä¼™æœ‰åˆ©ï¼Œè–„åˆ©å¤šé”€", career:"å›¢é˜Ÿåˆä½œï¼ŒåŠ›é‡å€å¢", love:"åƒå…„å¦¹/æœ‹å‹ä¸€æ ·çš„æ„Ÿæƒ…", g:"å‰" },
            "åœŸåœŸ": { r:"æ¯”å’Œ", t:"åŸºçŸ³ç¨³å›ºï¼Œæ²¡æœ‰å†²çªï¼Œå¹³ç¨³å‘å±•ã€‚", money:"ç§¯ç´¯å¾—è´¢ï¼Œç§¯å°‘æˆå¤š", career:"å®ˆæˆç¨³å›ºï¼Œæ²¡æœ‰å˜åŠ¨", love:"å¹³æ·¡è¸å®ï¼Œç»†æ°´é•¿æµ", g:"å‰" },
            "æ°´æ°´": { r:"æ¯”å’Œ", t:"æ°´æµæ±‡èšï¼Œé¡ºåŠ¿è€Œä¸ºï¼Œè™½æœ‰æ³¢æŠ˜ä½†æ— ç¢ã€‚", money:"è´¢æºä¸æ–­ï¼Œå¦‚æ°´é•¿æµ", career:"é¡ºåŠ¿è€Œä¸ºï¼Œæœ‰äººææº", love:"æ„Ÿæƒ…æ·±åšï¼Œæ¸©æŸ”å¦‚æ°´", g:"å‰" },
            "ç«ç«": { r:"æ¯”å’Œ", t:"å…‰æ˜äº’ç…§ï¼Œå£°åŠ¿æµ©å¤§ã€‚", money:"åæ°”ç”Ÿè´¢ï¼Œå¿«é€Ÿè·åˆ©", career:"å£°åå¤§å™ªï¼Œå¦‚æ—¥ä¸­å¤©", love:"å¹²æŸ´çƒˆç«ï¼Œçƒ­æƒ…ä¼¼ç«", g:"å‰" },
            "é‡‘æœ¨": { r:"ä½“å…‹ç”¨", t:"é‡‘èƒ½å…‹æœ¨ã€‚ä½ æŒæ¡ä¸»åŠ¨æƒï¼Œè™½ç„¶è´¹åŠ›ï¼Œä½†æœ€ç»ˆèƒ½æˆã€‚", money:"è¾›è‹¦æ±‚è´¢ï¼Œå¤šåŠ³å¤šå¾—", career:"æŒæ§å±€é¢ï¼Œéœ€è¦è´¹åŠ›", love:"ä½ å ä¸»å¯¼ï¼Œå¯¹æ–¹é¡ºä»", g:"å°å‰" },
            "æœ¨åœŸ": { r:"ä½“å…‹ç”¨", t:"æœ¨èƒ½å…‹åœŸã€‚ä½ æ ¹åŸºæ‰å®ï¼Œèƒ½æŒæ§å±€é¢ã€‚", money:"ä»åœŸä¸­ï¼ˆæˆ¿äº§ï¼‰è·åˆ©", career:"æ ¹åŸºæ‰å®ï¼Œå…‹æœå›°éš¾", love:"ä½ æ¯”è¾ƒå¼ºåŠ¿ï¼Œå¯¹æ–¹ç¨³é‡", g:"å°å‰" },
            "åœŸæ°´": { r:"ä½“å…‹ç”¨", t:"åœŸèƒ½æŒ¡æ°´ã€‚å…µæ¥å°†æŒ¡ï¼Œä½ èƒ½è§£å†³é—®é¢˜ã€‚", money:"æ±‚è´¢å—é˜»ï¼Œèµšè¾›è‹¦é’±", career:"å…µæ¥å°†æŒ¡ï¼Œè§£å†³é—®é¢˜", love:"ä½ ç®¡ç€å¯¹æ–¹ï¼Œå¯¹æ–¹å¬è¯", g:"å°å‰" },
            "æ°´ç«": { r:"ä½“å…‹ç”¨", t:"æ°´èƒ½ç­ç«ã€‚ä½ èƒ½å‹åˆ¶ä½å›°éš¾ï¼Œå æ®ä¼˜åŠ¿ã€‚", money:"æ™ºå–é’±è´¢ï¼Œç­–ç•¥è‡´èƒœ", career:"å‹åˆ¶å¯¹æ‰‹ï¼Œå æ®ä¼˜åŠ¿", love:"ä½ æ¯”è¾ƒå†·é™ï¼Œå¯¹æ–¹çƒ­æƒ…", g:"å°å‰" },
            "ç«é‡‘": { r:"ä½“å…‹ç”¨", t:"ç«èƒ½ç‚¼é‡‘ã€‚è¿™æ˜¯ç£¨ç»ƒï¼Œé€šè¿‡åŠªåŠ›ä¼šæœ‰æ”¶è·ã€‚", money:"ç«ä¸­å–æ —ï¼Œé™©ä¸­æ±‚è´¢", career:"æ”¹é©åˆ›æ–°ï¼Œæ”¹é€ ç¯å¢ƒ", love:"ä½ åœ¨ç£¨ç»ƒå¯¹æ–¹ï¼Œä½¿å…¶æ›´å¥½", g:"å°å‰" },
            "æœ¨é‡‘": { r:"ç”¨å…‹ä½“", t:"é‡‘å…‹æœ¨ã€‚å¤–ç•Œå‹åŠ›å¤§ï¼Œæœ‰é˜»ç¢ï¼Œç”šè‡³å—ä¼¤ã€‚", money:"ç ´è´¢ï¼Œå‹åŠ›å¤§ï¼Œéš¾æ±‚", career:"ä¸Šå¸æ–½å‹ï¼Œé˜»åŠ›é‡é‡", love:"å¯¹æ–¹å¼ºåŠ¿ï¼Œä½ å—å§”å±ˆ", g:"å‡¶" },
            "åœŸæœ¨": { r:"ç”¨å…‹ä½“", t:"æœ¨å…‹åœŸã€‚ç¯å¢ƒå¯¹ä½ ä¸åˆ©ï¼Œå†…éƒ¨å—æŸã€‚", money:"å› è´¢æ‹›ç¾ï¼Œå†…éƒ¨å—æŸ", career:"ç¯å¢ƒä¸åˆ©ï¼Œæ ¹åŸºå—æŸ", love:"å¯¹æ–¹å…‹åˆ¶ä½ ï¼Œæ„Ÿè§‰å‹æŠ‘", g:"å‡¶" },
            "æ°´åœŸ": { r:"ç”¨å…‹ä½“", t:"åœŸå…‹æ°´ã€‚ä½ æ„Ÿåˆ°å¤„å¤„å—é™ï¼Œéš¾ä»¥æ–½å±•ã€‚", money:"å¤„å¤„å—é™ï¼Œèµ„é‡‘è¢«å¥—", career:"æ€€æ‰ä¸é‡ï¼Œéš¾ä»¥æ–½å±•", love:"å¯¹æ–¹å›ºæ‰§ï¼Œä½ è§‰å¾—æ— è¶£", g:"å‡¶" },
            "ç«æ°´": { r:"ç”¨å…‹ä½“", t:"æ°´å…‹ç«ã€‚çƒ­æƒ…è¢«æµ‡ç­ï¼Œå¤–ç•Œåå¯¹å£°å¤§ã€‚", money:"æŠ•èµ„å¤±åˆ©ï¼Œçƒ­æƒ…è¢«æµ‡", career:"å—åˆ°æ‰“å‡»ï¼Œåå¯¹å£°å¤§", love:"å†·æˆ˜ï¼Œå¯¹æ–¹å¯¹ä½ å†·æ·¡", g:"å‡¶" },
            "é‡‘ç«": { r:"ç”¨å…‹ä½“", t:"ç«å…‹é‡‘ã€‚æ‰¿å—ç…ç†¬ï¼Œææœ‰æŸå¤±ã€‚", money:"ç…ç†¬è€—æŸï¼Œå¾—ä¸å¿å¤±", career:"ä»»åŠ¡è‰°å·¨ï¼Œèº«å¿ƒä¿±ç–²", love:"äº‰åµï¼Œå¯¹æ–¹è„¾æ°”å¤§", g:"å‡¶" },
            "æ°´é‡‘": { r:"ç”¨ç”Ÿä½“", t:"é‡‘ç”Ÿæ°´ã€‚äº‹æƒ…æ¥ç”ŸåŠ©ä½ ï¼Œä¸æ±‚è‡ªæ¥ã€‚", money:"è´µäººé€è´¢ï¼Œä¸æ±‚è‡ªæ¥", career:"å¾—é“å¤šåŠ©ï¼Œè½»æ¾æ™‹å‡", love:"å¯¹æ–¹å® ä½ ï¼Œä¸»åŠ¨ä»˜å‡º", g:"å¤§å‰" },
            "ç«æœ¨": { r:"ç”¨ç”Ÿä½“", t:"æœ¨ç”Ÿç«ã€‚å¤–ç•Œæä¾›èµ„æºåŠ©ä½ å‘å±•ã€‚", money:"èµ„æºå……è¶³ï¼Œè¶Šåšè¶Šå¤§", career:"å¤–ç•Œæ”¯æŒï¼Œé¡ºé£é¡ºæ°´", love:"å¯¹æ–¹æ—ºä½ ï¼Œçƒ­æƒ…ä¼¼ç«", g:"å¤§å‰" },
            "æœ¨æ°´": { r:"ç”¨ç”Ÿä½“", t:"æ°´ç”Ÿæœ¨ã€‚æœ‰è´µäººæ»‹å…»ï¼Œæˆé•¿è¿…é€Ÿã€‚", money:"é•¿è¾ˆèµ„åŠ©ï¼Œæ»‹å…»æˆé•¿", career:"å—äººææ‹”ï¼Œå‰é€”æ— é‡", love:"å¯¹æ–¹ç…§é¡¾ä½ ï¼Œæ¸©æŸ”ä½“è´´", g:"å¤§å‰" },
            "é‡‘åœŸ": { r:"ç”¨ç”Ÿä½“", t:"åœŸç”Ÿé‡‘ã€‚æœ‰é å±±æ”¯æŒï¼Œæˆ–è·åˆ©ã€‚", money:"åäº«å…¶æˆï¼Œæˆ¿äº§è·åˆ©", career:"é å±±ç¨³å›ºï¼Œåœ°ä½æå‡", love:"å¯¹æ–¹åŒ…å®¹ä½ ï¼Œç»™ä½ å®‰å…¨æ„Ÿ", g:"å¤§å‰" },
            "åœŸç«": { r:"ç”¨ç”Ÿä½“", t:"ç«ç”ŸåœŸã€‚è™½ç»ç£¨ç ºï¼Œç»ˆè·æ”¶ç›Šã€‚", money:"ååˆ©åŒæ”¶ï¼Œæ„å¤–ä¹‹è´¢", career:"ç»è¿‡ç£¨ç»ƒï¼Œç»ˆè·é‡ç”¨", love:"å¯¹æ–¹å´‡æ‹œä½ ï¼Œæ„Ÿæƒ…å‡æ¸©", g:"å¤§å‰" },
            "é‡‘æ°´": { r:"ä½“ç”Ÿç”¨", t:"æ°´æ³„é‡‘ã€‚ä½ ä»˜å‡ºå¾ˆå¤šï¼Œå¾—ä¸å¿å¤±ã€‚", money:"æŠ•èµ„æ— å›ï¼ŒèŠ±è´¹å·¨å¤§", career:"ä»˜å‡ºå¤ªå¤šï¼Œå¾—ä¸å¿å¤±", love:"ä½ ä»˜å‡ºå¤šï¼Œå¯¹æ–¹äº«å—", g:"å°å‡¶" },
            "æœ¨ç«": { r:"ä½“ç”Ÿç”¨", t:"æœ¨ç”Ÿç«ã€‚ç‡ƒçƒ§è‡ªå·±ç…§äº®åˆ«äººï¼ŒæŸè€—è‡ªèº«ã€‚", money:"ä¸ºåè€—è´¢ï¼Œè¡¨é¢å…‰é²œ", career:"ç‡ƒçƒ§è‡ªå·±ï¼Œç…§äº®åˆ«äºº", love:"ä½ å¾ˆçƒ­æƒ…ï¼Œå¯¹æ–¹æ…¢çƒ­", g:"å°å‡¶" },
            "æ°´æœ¨": { r:"ä½“ç”Ÿç”¨", t:"æ°´ç”Ÿæœ¨ã€‚èµ„æºè¢«å¯¹æ–¹å¸èµ°ã€‚", money:"å€Ÿé’±ç»™åˆ«äººï¼Œèµ„æºæµå¤±", career:"åŸ¹å…»ä¸‹å±ï¼Œè‡ªå·±æ“å¿ƒ", love:"ä½ åƒå®¶é•¿ä¸€æ ·ç…§é¡¾å¯¹æ–¹", g:"å°å‡¶" },
            "ç«åœŸ": { r:"ä½“ç”Ÿç”¨", t:"ç«ç”ŸåœŸã€‚æ“å¿ƒåŠ³ç¢Œï¼Œæˆå…¨äº†äº‹æƒ…ã€‚", money:"æ“å¿ƒåŠ³ç¢Œï¼Œæˆå…¨ä»–äºº", career:"åšå«è¡£è£³ï¼ŒåŠŸåŠ³è¢«å ", love:"ä½ å¤ªå® å¯¹æ–¹ï¼Œå¯¹æ–¹ä¹ æƒ¯", g:"å°å‡¶" },
            "åœŸé‡‘": { r:"ä½“ç”Ÿç”¨", t:"åœŸç”Ÿé‡‘ã€‚æŠ•èµ„ä»˜å‡ºï¼Œè¿™æ˜¯ä¸€ç§æ¶ˆè€—ã€‚", money:"æŠ•èµ„èŠ±è´¹ï¼Œè¿™æ˜¯ä¸€ç§æ¶ˆè€—", career:"è´¡çŒ®èµ„æºï¼Œæ”¯æŒä»–äºº", love:"ä½ ç»™å¯¹æ–¹é’±/ç‰©ï¼Œå•å‘ä»˜å‡º", g:"å°å‡¶" }
        };
        return relations[ti.w + yong.w];
    }

    function renderMeiHuaUI(res, lunar) {
        if(!res) return `<div class="result-card" style="text-align:center">è¯·è¾“å…¥æœ‰æ•ˆå†…å®¹</div>`;
        return `
            <div class="result-card">
                <div class="card-header">
                    <div class="h-title">æ¢…èŠ±æ˜“æ•°Â·ç™½è¯è¯¦æ‰¹</div>
                    <div class="h-meta">å…ˆå¤©æ•°ç†</div>
                </div>
                <div class="card-body">
                    <div class="gua-visual">
                        <div class="gua-item">
                            <div class="gua-icon">${res.up.icon}</div>
                            <div class="gua-text">ä¸Šå¦ï¼š${res.up.n} (${res.up.w})</div>
                        </div>
                        <div class="gua-arrow" style="display:${window.innerWidth<=768?'block':'none'}">
                            ${res.yao}çˆ»åŠ¨ â®•
                        </div>
                        <div class="gua-arrow" style="display:${window.innerWidth>768?'block':'none'}; transform:rotate(0deg);">
                             ${res.yao}çˆ»åŠ¨ â®•
                        </div>
                        <div class="gua-item">
                            <div class="gua-icon">${res.low.icon}</div>
                            <div class="gua-text">ä¸‹å¦ï¼š${res.low.n} (${res.low.w})</div>
                        </div>
                    </div>

                    <div class="logic-chain">
                        <b>æ¨æ¼”é€»è¾‘ï¼š</b> ${res.logs[0]}
                        <span class="logic-arrow">â†’</span>
                        ä¸Šå¦${res.up.n}ï¼Œä¸‹å¦${res.low.n}
                        <span class="logic-arrow">â†’</span>
                        ${res.yao}çˆ»åŠ¨
                        <span class="logic-arrow">â†’</span>
                        <span class="logic-highlight">ä½“å¦${res.ti.n}(${res.ti.w})ï¼Œç”¨å¦${res.yong.n}(${res.yong.w})</span>
                        <span class="logic-arrow">â†’</span>
                        å…³ç³»ï¼š${res.explain.r}
                    </div>

                    <div class="dimension-grid">
                        <div class="dimension-card">
                            <div class="dc-title">ğŸ’° è´¢è¿åˆ†æ</div>
                            <div class="dc-content">${res.explain.money}</div>
                        </div>
                        <div class="dimension-card">
                            <div class="dc-title">ğŸ’¼ æ±‚äº‹/äº‹ä¸š</div>
                            <div class="dc-content">${res.explain.career}</div>
                        </div>
                        <div class="dimension-card">
                            <div class="dc-title">â¤ï¸ çˆ±æƒ…/å©šå§»</div>
                            <div class="dc-content">${res.explain.love}</div>
                        </div>
                    </div>

                    <div class="book-ref">â€”â€” ä¾æ®ã€Šæ¢…èŠ±æ˜“æ•°ã€‹å·äºŒ [ä½“ç”¨ç”Ÿå…‹ç¯‡] è‡ªåŠ¨æ¨æ¼”</div>

                    ${renderChatInterface()}
                </div>
            </div>
        `;
    }

    // ================= å¥‡é—¨éç”² (V4.3) =================
    function calculateQiMen(lunar, scale, focus) {
        let juText, logicText, grid, analysis;
        
        if (scale === 'year') {
            const year = lunar.getYear();
            const yuan = Math.floor((year - 1864) / 60) % 3;
            const ju = [1, 4, 7][yuan];
            juText = `å¹´å®¶å¥‡é—¨ Â· é˜´é${ju}å±€`;
            logicText = `${lunar.getYearInGanZhi()}å¹´ï¼Œå±äº${['ä¸Š','ä¸­','ä¸‹'][yuan]}å…ƒã€‚`;
            grid = genGrid(ju);
            analysis = { t: "å¹´å®¶å¥‡é—¨çœ‹å¤§å±€ï¼Œä¸çœ‹çäº‹ã€‚å¤©ç›˜å€¼ç¬¦ä»£è¡¨å›½è¿ã€‚", b: "ã€Šå¥‡é—¨å®é‰´ã€‹" };
        } 
        else if (scale === 'month') {
            juText = `æœˆå®¶å¥‡é—¨ Â· é˜´é1å±€`;
            logicText = `ä¾æ®å¹´å¹²æ”¯å®šå±€ï¼Œç”²å­å¹´æˆŠè¾°æœˆç”¨é˜´ä¸€å±€ã€‚`;
            grid = genGrid(1);
            analysis = { t: "æœˆå®¶å¥‡é—¨çœ‹æœ¬æœˆè°‹æœ›ã€‚é‡ç‚¹çœ‹å€¼ç¬¦è½å®«æ˜¯å¦æ—ºç›¸ã€‚", b: "ã€Šå¥‡é—¨å®é‰´ã€‹å·äºŒ" };
        }
        else if (scale === 'day') {
            const dz = lunar.getDayZhi();
            const ju = RI_JIA_MAP[dz];
            juText = `æ—¥å®¶å¥‡é—¨ Â· é˜³é${ju}å±€`;
            logicText = `å­åˆæ—¥ç”¨äºŒå±€...ä»Šæ—¥${dz}æ—¥ï¼Œæ•…ç”¨${ju}å±€ã€‚`;
            grid = genGrid(ju);
            analysis = { t: "æ—¥å®¶å¥‡é—¨ç”¨äºæ‹©æ—¥å‡ºè¡Œã€‚ä»Šæ—¥ç”Ÿé—¨åœ¨ä¸œåŒ—ï¼Œå‰ã€‚", b: "ã€Šç»Ÿå®—ã€‹" };
        }
        else {
            const jieQi = lunar.getPrevJieQi(true);
            juText = `æ—¶å®¶å¥‡é—¨ Â· ${jieQi.getName()}é˜³é1å±€`;
            logicText = `ç¬¦å¤´æ­£æˆï¼Œç”¨æœ¬èŠ‚æ°”ä¸Šå…ƒå±€ã€‚`;
            grid = genGrid(1);
            analysis = getShiJiaAnalysis(focus);
        }

        return { juText, logicText, grid, analysis, scale, type:'qimen' };
    }

    function renderQiMenReport(res, lunar, scale) {
        let explainHtml = "";
        if (scale === 'hour') {
            explainHtml = `
                <div class="vernacular-box">
                    <div class="vb-title">ç»“æœç›´æ–­</div>
                    <div class="logic-chain" style="background:#fff; border:1px dashed #ccc; margin-bottom:15px;">
                        <b>æ¨ç®—ä¾æ®ï¼š</b>${res.analysis.logic}
                    </div>
                    <div class="vernacular">
                        <strong>ç»“è®ºï¼š</strong>${res.analysis.result}
                    </div>
                    <div class="book-ref">â€”â€”${res.analysis.book}</div>
                </div>
            `;
        } else {
            explainHtml = `<div class="vernacular-box"><div class="vernacular">${res.analysis.t}</div></div>`;
        }

        return `
            <div class="result-card">
                <div class="card-header">
                    <div class="h-title">${res.juText}</div>
                    <div class="h-meta">${lunar.getDayInGanZhi()}æ—¥</div>
                </div>
                
                <div class="card-body">
                    <div class="step-log"><b>æ¨æ¼”ä¾æ®ï¼š</b>${res.logicText}</div>
                    <div style="margin:20px 0;">${res.grid}</div>
                    ${explainHtml}
                    ${renderChatInterface()}
                </div>
            </div>
        `;
    }

    function genGrid(ju) {
        const layout = [
            {p:"å·½å››", s:"å¤©è¾…", d:"æœé—¨", g:"å…­åˆ", stem:"ç”²/ä¸™"},
            {p:"ç¦»ä¹", s:"å¤©è‹±", d:"æ™¯é—¨", g:"ç™½è™", stem:"ä¹™/åºš"},
            {p:"å¤äºŒ", s:"å¤©èŠ®", d:"æ­»é—¨", g:"ç„æ­¦", stem:"å£¬/ä¸"},
            {p:"éœ‡ä¸‰", s:"å¤©å†²", d:"ä¼¤é—¨", g:"å¤ªé˜´", stem:"ç™¸/æˆŠ"},
            {p:"ä¸­äº”", s:"å¤©ç¦½", d:"", g:"", stem:"ä¸™"},
            {p:"å…‘ä¸ƒ", s:"å¤©æŸ±", d:"æƒŠé—¨", g:"ä¹åœ°", stem:"æˆŠ/ç™¸"},
            {p:"è‰®å…«", s:"å¤©ä»»", d:"ç”Ÿé—¨", g:"è£è›‡", stem:"ä¸™/å£¬"},
            {p:"åä¸€", s:"å¤©è“¬", d:"ä¼‘é—¨", g:"å€¼ç¬¦", stem:"åºš/ä¹™"},
            {p:"ä¹¾å…­", s:"å¤©å¿ƒ", d:"å¼€é—¨", g:"ä¹å¤©", stem:"è¾›/å·±"}
        ];
        
        let html = '<div class="qimen-grid">';
        layout.forEach(c => {
            html += `
                <div class="q-cell">
                    <div class="q-pos">${c.p}</div>
                    <div class="q-god">${c.g}</div>
                    <div class="q-star">${c.s}</div>
                    <div class="q-door">${c.d}</div>
                    <div class="q-gan">${c.stem}</div>
                </div>`;
        });
        return html + '</div>';
    }

    function getShiJiaAnalysis(focus) {
        if(focus === 'wealth') return {
            logic: "ç”¨ç¥ã€ç”Ÿé—¨ã€‘è½è‰®åœŸå®«ï¼Œã€ç”²å­æˆŠã€‘è½å…‘é‡‘å®«ã€‚åœŸç”Ÿé‡‘ï¼Œå³åˆ©æ¶¦ç”Ÿæœ¬é‡‘ã€‚",
            result: "å¤§å‰ã€‚æŠ•èµ„èƒ½è·åˆ©ï¼Œä¸”åˆ©æ¶¦ä¼šä¸»åŠ¨æ‰¾ä¸Šé—¨ã€‚å› ä¸ºè‰®å®«ä¸ºå±±ï¼Œå¯èƒ½æ¶‰åŠçŸ¿äº§ã€æˆ¿äº§æˆ–åœæ­¢åçš„é‡å¯é¡¹ç›®ã€‚",
            book: "ã€Šå¥‡é—¨éç”²å…ƒçµç»ã€‹å·åå…­"
        };
        if(focus === 'marriage') return {
            logic: "ç”¨ç¥ã€ä¹™å¥‡ã€‘(å¥³)åœ¨ç¦»ç«å®«ï¼Œã€åºšé‡‘ã€‘(ç”·)åœ¨åæ°´å®«ã€‚æ°´å…‹ç«ï¼Œä¸”åç¦»å¯¹å†²ã€‚",
            result: "å‡¶ã€‚ç”·æ–¹å…‹åˆ¶å¥³æ–¹ï¼Œä¸¤äººæ€§æ ¼æ°´ç«ä¸å®¹ã€‚è€Œä¸”å®«ä½å¯¹å†²ï¼Œä»£è¡¨å†²çªæ¿€çƒˆï¼Œè¿™æ¡©å©šäº‹å¾ˆéš¾æˆã€‚",
            book: "ã€Šå¥‡é—¨éç”²ç»Ÿå®—ã€‹å·å"
        };
        if(focus === 'career') return {
            logic: "ç”¨ç¥ã€å¼€é—¨ã€‘åœ¨ä¹¾å…­å®«ï¼Œã€å¹´å¹²ã€‘(é¢†å¯¼)åœ¨åä¸€å®«ã€‚é‡‘ç”Ÿæ°´ã€‚",
            result: "å‰ã€‚å·¥ä½œç”ŸåŠ©é¢†å¯¼ï¼Œè¯´æ˜ä½ çš„å·¥ä½œè¡¨ç°å¾—åˆ°äº†ä¸Šçº§çš„è®¤å¯ã€‚å¼€é—¨åœ¨ä¹¾å®«ä¸ºå¾—åœ°ï¼Œåˆ©äºå‡è¿ã€‚",
            book: "ã€Šå¥‡é—¨å®é‰´ã€‹å·ä¹"
        };
        if(focus === 'lost') return {
            logic: "ç”¨ç¥ã€ç„æ­¦ã€‘åœ¨å¤äºŒå®«(åœŸ)ï¼Œã€æ—¶å¹²ã€‘åœ¨éœ‡ä¸‰å®«(æœ¨)ã€‚æœ¨å…‹åœŸã€‚",
            result: "èƒ½æ‰¾å›ã€‚å¤±ä¸»(æ—¶å¹²)å…‹åˆ¶ç›—è´¼(ç„æ­¦)ï¼Œè¯´æ˜ä½ èƒ½åˆ¶ä½å°å·ã€‚å¤å®«ä»£è¡¨è¥¿å—æ–¹æˆ–ä½å¤„ã€‚",
            book: "ã€Šå…ƒçµç»ã€‹å·åå…«"
        };
        return {
            logic: "å€¼ç¬¦è½åä¸€å®«ï¼Œå¤©è“¬æ˜Ÿä¸´å€¼ã€‚",
            result: "å¹³ã€‚å½“å‰æ—¶è¿å®œå®ˆä¸å®œæ”»ã€‚å¤©è“¬æ˜Ÿè™½ç„¶å‡¶ï¼Œä½†æœ‰å€¼ç¬¦é•‡å®ˆï¼Œæ— å¤§ç¢ã€‚å»ºè®®ä¿®æ•´è§„åˆ’ã€‚",
            book: "ã€Šå¾¡å®šå¥‡é—¨å®é‰´ã€‹"
        };
    }

    // ================= AI èŠå¤©æ¥å£ =================
    function renderChatInterface() {
        return `
            <div class="chat-container">
                <div class="chat-header">ğŸ”® æ™ºèƒ½æ˜“å­¦é¡¾é—®</div>
                <div class="chat-history" id="chat-history">
                    <div class="chat-msg bot">
                        <div class="bubble">æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„æ™ºèƒ½æ˜“å­¦é¡¾é—®ã€‚æ‚¨å¯ä»¥ç›´æ¥é—®æˆ‘ï¼Œä¾‹å¦‚ï¼šâ€œè¿™å¦èƒ½èµšé’±å—ï¼Ÿâ€ã€â€œä»–å–œæ¬¢æˆ‘å—ï¼Ÿâ€</div>
                    </div>
                </div>
                <div class="chat-input-area">
                    <input type="text" class="chat-input" id="user-input" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." onkeypress="handleKey(event)">
                    <button class="chat-btn" onclick="sendMsg()">æé—®</button>
                </div>
            </div>
        `;
    }

    function handleKey(e) { if(e.key==='Enter') sendMsg(); }

    function sendMsg() {
        const input = document.getElementById('user-input');
        const text = input.value.trim();
        if(!text) return;
        
        addMsg('user', text);
        input.value = '';

        setTimeout(() => {
            const reply = generateSmartReply(text);
            addMsg('bot', reply);
        }, 600);
    }

    function addMsg(role, text) {
        const h = document.getElementById('chat-history');
        h.innerHTML += `<div class="chat-msg ${role}"><div class="bubble">${text}</div></div>`;
        h.scrollTop = h.scrollHeight;
    }

    function generateSmartReply(q) {
        if (!currentResult) return "è¯·å…ˆç‚¹å‡»â€œå¼€å§‹æ¨æ¼”â€ç”Ÿæˆå¦è±¡ã€‚";
        const qText = q.toLowerCase();
        
        let intent = 'general';
        if (qText.match(/è´¢|é’±|èµš|ç›ˆ|äº|èµ„/)) intent = 'wealth';
        else if (qText.match(/å©š|æ‹|çˆ±|æƒ…|ç”·|å¥³|å–œæ¬¢/)) intent = 'love';
        else if (qText.match(/å·¥|èŒ|ä¸š|å®˜|å‡|é™/)) intent = 'career';
        
        if (currentResult.type === 'meihua') {
            const exp = currentResult.explain;
            const resMap = {
                'wealth': { label: 'è´¢è¿', val: exp.money },
                'love': { label: 'æ„Ÿæƒ…', val: exp.love },
                'career': { label: 'äº‹ä¸š', val: exp.career },
                'general': { label: 'è¿åŠ¿', val: exp.t }
            };
            const target = resMap[intent];
            
            let directAns = "";
            if (exp.g.includes("å‰")) directAns = "æ˜¯çš„ï¼Œå¾ˆæœ‰å¸Œæœ›ã€‚";
            else if (exp.g.includes("å‡¶")) directAns = "ä¸å¤ªä¹è§‚ï¼Œéœ€è¦è°¨æ…ã€‚";
            else directAns = "æƒ…å†µå¹³ç¨³ï¼Œåœ¨äºäººä¸ºã€‚";
            
            return `ã€${target.label}ã€‘${directAns} <br>ä¾æ®ï¼šæœ¬å¦æ˜¾ç¤ºâ€œ${exp.r}â€ã€‚å…·ä½“æ¥è¯´ï¼š${target.val}`;
        } 
        else {
            let tempAnalysis = getShiJiaAnalysis(intent === 'love' ? 'marriage' : intent); 
            if (intent === 'general') tempAnalysis = currentResult.analysis;

            return `ã€ç›´æ¥å›ç­”ã€‘${tempAnalysis.result.split("ã€‚")[0]}ã€‚<br>ã€æ¨æ–­ç†ç”±ã€‘${tempAnalysis.logic}`;
        }
    }

</script>
</body>

</html>


